<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Matkaopas Pro - Korjattu Tapahtumahaku</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #007bff; --success: #28a745; --warning: #f39c12; --bg: #f8f9fa; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 20px auto; padding: 0 20px; background-color: var(--bg); color: #333; }
        
        .kaupunki-valitsin { background: var(--dark); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .kaupunki-valitsin select { padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .kortti { padding: 15px; border-radius: 12px; color: white; min-height: 120px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .saa-kortti { background: linear-gradient(135deg, var(--primary), #00c6ff); }
        .tapahtuma-kortti { background: linear-gradient(135deg, #6f42c1, #a951ed); overflow-y: auto; max-height: 250px; }

        .tapahtuma-rivi { border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0; font-size: 0.8em; }
        .tapahtuma-rivi:last-child { border: none; }
        .tapahtuma-linkki { color: #ffeb3b; text-decoration: none; font-weight: bold; border-bottom: 1px dashed; }

        #map { height: 400px; width: 100%; border-radius: 12px; margin-bottom: 20px; z-index: 1; border: 1px solid #ddd; }
        .gps-nappi { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .kohde-kortti { background: white; border-radius: 12px; padding: 20px; display: flex; gap: 20px; align-items: flex-start; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .kohde-kuva { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .kayty { background-color: #e8f5e9 !important; border: 1px solid #a5d6a7; }
        .etaisyys-tagi { display: inline-block; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; margin-bottom: 5px; }

        .nappi-ryhma { display: flex; flex-direction: column; gap: 8px; min-width: 120px; }
        .nappi { cursor: pointer; padding: 8px; border: none; border-radius: 6px; font-size: 0.8em; text-align: center; text-decoration: none; font-weight: bold; }
        .nappi-sivu { background: #6c757d; color: white; }
        .nappi-kartta { background: var(--primary); color: white; }
        .nappi-kayty.aktiivinen { background: var(--success); color: white; }

        @media (max-width: 700px) { .info-grid { grid-template-columns: 1fr; } .kohde-kortti { flex-direction: column; } }
    </style>
</head>
<body>

    <div class="kaupunki-valitsin">
        <div style="font-weight: bold;">üåç Matkaopas Pro</div>
        <select id="citySelect" onchange="vaihdaKaupunki()">
            <option value="vilna">üá±üáπ Vilna</option>
            <option value="praha">üá®üáø Praha</option>
            <option value="rooma" selected>üáÆüáπ Rooma</option>
            <option value="pori">üá´üáÆ Pori</option>
        </select>
    </div>

    <div class="info-grid">
        <div id="saa-osio" class="kortti saa-kortti">
            <div style="font-weight: bold; font-size: 0.9em; margin-bottom: 5px;">S√§√§</div>
            <div id="nyky-temp" style="font-size: 2em; font-weight: bold;">--¬∞C</div>
            <div id="nyky-kuvaus">Ladataan...</div>
        </div>

        <div id="tapahtuma-osio" class="kortti tapahtuma-kortti">
            <div style="font-weight: bold; font-size: 0.9em; margin-bottom: 5px;">Tapahtumat (L√§hiaikoina)</div>
            <div id="tapahtuma-lista">Haetaan tapahtumia...</div>
        </div>
    </div>

    <div style="position: relative;">
        <div id="map"></div>
        <button class="gps-nappi" onclick="haeOmaSijainti()">üìç Miss√§ olen?</button>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <input type="text" id="hakukentta" placeholder="Hae kohdetta..." oninput="suodata()" style="flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
        <select id="kategoriaSuodatin" onchange="suodata()" style="padding: 10px; border-radius: 6px;">
            <option value="kaikki">Kaikki</option>
            <option value="Suosittu n√§ht√§vyys">Suositut</option>
            <option value="Ravintola">Ravintolat</option>
        </select>
    </div>

    <div id="lista"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const cityConfig = {
            vilna: { json: 'vilna_locations.json', lat: 54.6872, lon: 25.2797, name: 'Vilnius', countryCode: 'LT', storageKey: 'kaytyVilna', primary: '#007bff' },
            praha: { json: 'prague_locations.json', lat: 50.0875, lon: 14.4214, name: 'Prague', countryCode: 'CZ', storageKey: 'kaytyPrague', primary: '#d32f2f' },
            rooma: { json: 'rome_locations.json', lat: 41.8902, lon: 12.4922, name: 'Rome', countryCode: 'IT', storageKey: 'kaytyRooma', primary: '#c0392b' },
            pori: { json: 'pori_locations.json', lat: 61.4851, lon: 21.7911, name: 'Pori', countryCode: 'FI', storageKey: 'kaytyPori', primary: '#ff6600', eventUrl: 'https://tapahtumat.pori.fi' }
        };

        let nykyinenKaupunki = 'rooma';
        let kaikkiKohteet = [];
        let userLat = null, userLon = null;
        let map, markerGroup, userMarker;

        async function haeTapahtumat() {
            const config = cityConfig[nykyinenKaupunki];
            const listaDiv = document.getElementById('tapahtuma-lista');
            
            if (nykyinenKaupunki === 'pori') {
                listaDiv.innerHTML = `<a href="${config.eventUrl}" target="_blank" class="tapahtuma-linkki">Avaa Porin tapahtumakalenteri ‚Üí</a>`;
                return;
            }

            try {
                // Huom: T√§m√§ on jaettu demoavain. Jos se lakkaa toimimasta, hanki oma developer.ticketmaster.com
                const apiKey = '7elSST36dpA97vM2B94WvH2X8U5Wp3x9'; 
                const url = `https://app.ticketmaster.com/discovery/v2/events.json?apikey=${apiKey}&city=${config.name}&countryCode=${config.countryCode}&size=8&sort=date,asc`;
                
                const res = await fetch(url);
                const data = await res.json();

                if (data._embedded && data._embedded.events) {
                    let html = '';
                    data._embedded.events.forEach(ev => {
                        const date = ev.dates.start.localDate ? new Date(ev.dates.start.localDate).toLocaleDateString('fi-FI') : 'Aika avoin';
                        html += `<div class="tapahtuma-rivi">
                                    <b>${date}</b>: ${ev.name.substring(0, 35)}${ev.name.length > 35 ? '...' : ''} 
                                    <br><a href="${ev.url}" target="_blank" class="tapahtuma-linkki">Katso tiedot ja liput</a>
                                 </div>`;
                    });
                    listaDiv.innerHTML = html;
                } else {
                    listaDiv.innerHTML = "Ei l√∂ytynyt tulevia suuria tapahtumia t√§ll√§ haulla.";
                }
            } catch (e) {
                console.error("Ticketmaster Error:", e);
                listaDiv.innerHTML = "Tapahtumien lataus ei juuri nyt onnistunut (API-rajoitus).";
            }
        }

        function alustaKartta() {
            if (map) map.remove();
            const config = cityConfig[nykyinenKaupunki];
            map = L.map('map').setView([config.lat, config.lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markerGroup = L.layerGroup().addTo(map);
        }

        async function vaihdaKaupunki() {
            nykyinenKaupunki = document.getElementById('citySelect').value;
            const config = cityConfig[nykyinenKaupunki];
            document.documentElement.style.setProperty('--primary', config.primary);
            
            alustaKartta();
            haeSaa();
            haeTapahtumat();
            
            try {
                const res = await fetch(config.json);
                kaikkiKohteet = await res.json();
                suodata();
            } catch (e) { console.error("JSON load error:", e); }
        }

        async function haeSaa() {
            const config = cityConfig[nykyinenKaupunki];
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&current_weather=true`);
                const data = await res.json();
                document.getElementById('nyky-temp').textContent = `${Math.round(data.current_weather.temperature)}¬∞C`;
                document.getElementById('nyky-kuvaus').textContent = config.name;
            } catch(e) {}
        }

        function haeOmaSijainti() {
            navigator.geolocation.getCurrentPosition((pos) => {
                userLat = pos.coords.latitude; userLon = pos.coords.longitude;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker([userLat, userLon], { radius: 8, fillColor: "#007bff", color: "white", weight: 2, fillOpacity: 0.8 }).addTo(map);
                map.setView([userLat, userLon], 14);
                suodata();
            });
        }

        function laskeEtaisyys(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function naytaKohteet(kohteet) {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            const config = cityConfig[nykyinenKaupunki];
            const kaytyLista = JSON.parse(localStorage.getItem(config.storageKey)) || [];

            if (userLat) {
                kohteet.forEach(i => i.dist = laskeEtaisyys(userLat, userLon, i.lat, i.lon));
                kohteet.sort((a, b) => a.dist - b.dist);
            }

            markerGroup.clearLayers();
            kohteet.forEach(item => {
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lon}`;
                const onKayty = kaytyLista.includes(item.kohde);
                const distT = item.dist ? `<div class="etaisyys-tagi">üìç ${item.dist.toFixed(1)} km</div>` : '';

                lista.innerHTML += `
                    <div class="kohde-kortti ${onKayty ? 'kayty' : ''}">
                        <img src="${item.kuva}" class="kohde-kuva" onerror="this.src='https://via.placeholder.com/100'">
                        <div style="flex-grow: 1;">
                            ${distT}
                            <div style="font-weight: bold; color: var(--primary);">${item.kohde}</div>
                            <div style="font-size: 0.8em; margin: 4px 0;">${item.kuvaus}</div>
                        </div>
                        <div class="nappi-ryhma">
                            <a href="${mapsUrl}" target="_blank" class="nappi nappi-kartta">Kartta</a>
                            <button class="nappi ${onKayty ? 'aktiivinen' : ''}" onclick="toggleKayty('${item.kohde}')" style="background:${onKayty ? '' : '#eee'}">
                                ${onKayty ? '‚úì K√§yty' : 'K√§yty'}
                            </button>
                        </div>
                    </div>`;
                L.marker([item.lat, item.lon]).addTo(markerGroup).bindPopup(`<b>${item.kohde}</b>`);
            });
        }

        function suodata() {
            const h = document.getElementById('hakukentta').value.toLowerCase();
            const s = kaikkiKohteet.filter(i => i.kohde.toLowerCase().includes(h));
            naytaKohteet(s);
        }

        function toggleKayty(id) {
            const config = cityConfig[nykyinenKaupunki];
            let l = JSON.parse(localStorage.getItem(config.storageKey)) || [];
            const i = l.indexOf(id);
            if (i > -1) l.splice(i, 1); else l.push(id);
            localStorage.setItem(config.storageKey, JSON.stringify(l));
            suodata();
        }

        vaihdaKaupunki();
    </script>
</body>
</html>
