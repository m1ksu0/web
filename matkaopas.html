<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Travel Guide</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --warning: #f39c12;
            --bg: #f8f9fa;
            --dark: #2c3e50;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; max-width: 900px; margin: 20px auto; padding: 0 20px; background-color: var(--bg); color: #333; }
        
        .kaupunki-valitsin {
            background: var(--dark); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .kaupunki-valitsin select { padding: 10px 15px; border-radius: 6px; font-size: 1em; font-weight: bold; cursor: pointer; border: none; }

        .saa-sailyty {
            background: linear-gradient(135deg, var(--primary), #00c6ff);
            color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,123,255,0.3);
        }
        .saa-nykyinen { display: flex; align-items: center; justify-content: space-between; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.3); margin-bottom: 10px; }
        .saa-ennuste { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; }
        .ennuste-paiva { background: rgba(255,255,255,0.1); padding: 8px; border-radius: 8px; font-size: 0.85em; }

        .kartta-sailyty { position: relative; margin-bottom: 25px; }
        #map { height: 450px; width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1; }
        .gps-nappi {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px;
            padding: 8px 12px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .haku-alue { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; 
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex-grow: 1; }

        .kohde-kortti { 
            background: white; border-radius: 12px; padding: 20px; display: flex; gap: 20px; 
            align-items: flex-start; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .kayty { background-color: #e8f5e9 !important; border: 1px solid #a5d6a7; }
        .kohde-kuva { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; flex-shrink: 0; background: #eee; border: 1px solid #ddd; }
        .etaisyys-tagi { display: inline-block; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 4px; font-size: 0.85em; font-weight: bold; margin-bottom: 5px; }

        .nappi-ryhma { display: flex; flex-direction: column; gap: 8px; min-width: 140px; }
        .nappi { cursor: pointer; padding: 10px; border: none; border-radius: 6px; font-size: 0.85em; text-align: center; text-decoration: none; font-weight: bold; display: block; }
        .nappi-kartta { background: var(--primary); color: white; }
        .nappi-kayty { background: white; border: 1px solid #ccc; color: #555; }
        .nappi-kayty.aktiivinen { background: var(--success); color: white; border-color: var(--success); }

        @media (max-width: 650px) {
            .kohde-kortti { flex-direction: column; }
            .nappi-ryhma { width: 100%; flex-direction: row; flex-wrap: wrap; }
            .nappi { flex: 1; min-width: 110px; }
        }
    </style>
</head>
<body>

    <div class="kaupunki-valitsin">
        <div style="font-weight: bold; font-size: 1.2em;">ğŸŒ Matkaopas</div>
        <select id="citySelect" onchange="vaihdaKaupunki()">
            <option value="vilna">ğŸ‡±ğŸ‡¹ Vilna, Liettua</option>
            <option value="gdansk">ğŸ‡µğŸ‡± GdaÅ„sk, Puola</option>
            <option value="praha">ğŸ‡¨ğŸ‡¿ Praha, TÅ¡ekki</option>
            <option value="munchen">ğŸ‡©ğŸ‡ª MÃ¼nchen, Saksa</option>
            <option value="rooma">ğŸ‡®ğŸ‡¹ Rooma, Italia</option>
            <option value="torino">ğŸ‡®ğŸ‡¹ Torino, Italia</option>
            <option value="pori">ğŸ‡«ğŸ‡® Pori, Suomi</option>
        </select>
    </div>

    <div id="saa-osio" class="saa-sailyty">
        <div class="saa-nykyinen">
            <div><div id="saa-kaupunki" style="font-weight: bold; font-size: 1.2em;">Ladataan...</div><div id="nyky-kuvaus">--</div></div>
            <div id="nyky-ikoni" style="font-size: 3.5em;">â˜ï¸</div>
            <div id="nyky-temp" style="font-size: 2.5em; font-weight: bold;">--Â°C</div>
        </div>
        <div id="ennuste-rivit" class="saa-ennuste"></div>
    </div>

    <div class="kartta-sailyty">
        <div id="map"></div>
        <button class="gps-nappi" onclick="haeOmaSijainti()">ğŸ“ MissÃ¤ olen?</button>
    </div>

    <div class="haku-alue">
        <input type="text" id="hakukentta" placeholder="Etsi kohdetta..." oninput="suodata()">
        <select id="kategoriaSuodatin" onchange="suodata()">
            <option value="kaikki">Kaikki kategoriat</option>
            <option value="Suosittu nÃ¤htÃ¤vyys">Suosituimmat</option>
            <option value="NÃ¤htÃ¤vyys">NÃ¤htÃ¤vyydet</option>
            <option value="Museo">Museot</option>
            <option value="Ravintola">Ravintolat</option>
            <option value="Suosittu kahvila">Kahvilat</option>
            <option value="Kauppakeskus">Kauppakeskukset</option>
        </select>
        <span id="laskuri" style="font-weight: bold; color: var(--primary); padding-left: 10px;"></span>
    </div>

    <div id="lista"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const cityConfig = {
            vilna: { json: 'vilna_locations.json', lat: 54.6872, lon: 25.2797, storageKey: 'kaytyVilna', name: 'Vilna', color: 'linear-gradient(135deg, #007bff, #00c6ff)', primary: '#007bff' },
            gdansk: { json: 'gdansk_locations.json', lat: 54.352, lon: 18.646, storageKey: 'kaytyGdansk', name: 'Gdansk', color: 'linear-gradient(135deg, #dc143c, #8b0000)', primary: '#dc143c' },
            praha: { json: 'prague_locations.json', lat: 50.0875, lon: 14.4214, storageKey: 'kaytyPrague', name: 'Praha', color: 'linear-gradient(135deg, #d32f2f, #ff6659)', primary: '#d32f2f' },
            munchen: { json: 'munich_locations.json', lat: 48.137, lon: 11.575, storageKey: 'kaytyMunchen', name: 'Munchen', color: 'linear-gradient(135deg, #00adef, #005aab)', primary: '#005aab' },
            rooma: { json: 'rome_locations.json', lat: 41.8902, lon: 12.4922, storageKey: 'kaytyRooma', name: 'Rooma', color: 'linear-gradient(135deg, #e5a01a, #c0392b)', primary: '#c0392b' },
            torino: { json: 'turin_locations.json', lat: 45.07, lon: 7.68, storageKey: 'kaytyTorino', name: 'Turin', color: 'linear-gradient(135deg, #8b0000, #ff4500)', primary: '#8b0000' },
            pori: { json: 'pori_locations.json', lat: 61.4851, lon: 21.7911, storageKey: 'kaytyPori', name: 'Pori', color: 'linear-gradient(135deg, #ffcc00, #ff6600)', primary: '#ff6600' }
        };

        let nykyinenKaupunki = 'vilna';
        let kaikkiKohteet = [];
        let userLat = null, userLon = null;
        let map, markerGroup, userMarker;

        const saaKuvaukset = {
            0: ["SelkeÃ¤Ã¤", "â˜€ï¸"], 1: ["Melkein selkeÃ¤Ã¤", "ğŸŒ¤ï¸"], 2: ["PuolipilvistÃ¤", "â›…"], 3: ["PilvistÃ¤", "â˜ï¸"],
            45: ["Sumua", "ğŸŒ«ï¸"], 51: ["Tihkua", "ğŸŒ§ï¸"], 61: ["Vesisadetta", "ğŸŒ§ï¸"], 71: ["Lunta", "â„ï¸"], 95: ["Ukkosta", "â›ˆï¸"]
        };

        function laskeEtaisyys(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function alustaKartta() {
            if (map) map.remove();
            const config = cityConfig[nykyinenKaupunki];
            map = L.map('map').setView([config.lat, config.lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
            markerGroup = L.layerGroup().addTo(map);
        }

        async function vaihdaKaupunki() {
            nykyinenKaupunki = document.getElementById('citySelect').value;
            const config = cityConfig[nykyinenKaupunki];
            document.getElementById('saa-osio').style.background = config.color;
            document.documentElement.style.setProperty('--primary', config.primary);
            alustaKartta();
            haeSaa();
            try {
                const res = await fetch(config.json);
                kaikkiKohteet = await res.json();
                suodata();
            } catch (e) { console.error("Latausvirhe:", e); }
        }

        async function haeSaa() {
            const config = cityConfig[nykyinenKaupunki];
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${config.lat}&longitude=${config.lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe%2FBerlin`);
                const data = await res.json();
                const nyky = data.current_weather;
                document.getElementById('saa-kaupunki').textContent = config.name + " Nyt";
                document.getElementById('nyky-temp').textContent = `${Math.round(nyky.temperature)}Â°C`;
                document.getElementById('nyky-kuvaus').textContent = (saaKuvaukset[nyky.weathercode] || ["Vaihtelevaa"])[0];
                document.getElementById('nyky-ikoni').textContent = (saaKuvaukset[nyky.weathercode] || ["", "â›…"])[1];

                const ennusteElementti = document.getElementById('ennuste-rivit');
                ennusteElementti.innerHTML = '';
                for (let i = 1; i <= 3; i++) {
                    const d = data.daily;
                    ennusteElementti.innerHTML += `<div class="ennuste-paiva"><b>${new Date(d.time[i]).toLocaleDateString('fi-FI', {weekday:'short'})}</b><br>${saaKuvaukset[d.weathercode[i]][1]}<br>${Math.round(d.temperature_2m_max[i])}Â° / ${Math.round(d.temperature_2m_min[i])}Â°</div>`;
                }
            } catch (e) {}
        }

        function haeOmaSijainti() {
            if (!navigator.geolocation) return alert("Ei GPS-tukea.");
            navigator.geolocation.getCurrentPosition((pos) => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.circleMarker([userLat, userLon], { radius: 10, fillColor: "#007bff", color: "white", weight: 3, fillOpacity: 0.8 }).addTo(map);
                map.setView([userLat, userLon], 15);
                suodata();
            });
        }

        function naytaKohteet(kohteet) {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            const config = cityConfig[nykyinenKaupunki];
            const kaytyLista = JSON.parse(localStorage.getItem(config.storageKey)) || [];

            if (userLat !== null) {
                kohteet.forEach(item => item.dist = laskeEtaisyys(userLat, userLon, item.lat, item.lon));
                kohteet.sort((a, b) => a.dist - b.dist);
            }

            markerGroup.clearLayers();

            kohteet.forEach(item => {
                const onKayty = kaytyLista.includes(item.kohde);
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lon}`;
                const distText = item.dist ? `<div class="etaisyys-tagi">ğŸ“ ${item.dist.toFixed(1)} km pÃ¤Ã¤ssÃ¤</div>` : '';

                lista.innerHTML += `
                    <div class="kohde-kortti ${onKayty ? 'kayty' : ''}">
                        <img src="${item.kuva}" class="kohde-kuva" loading="lazy" onerror="this.onerror=null; this.src='https://placehold.co/400x300?text=${item.kohde}';">
                        <div class="kohde-sisalto">
                            ${distText}
                            <div style="font-size: 0.7em; text-transform: uppercase; color: #999; font-weight: bold;">${item.kategoria}</div>
                            <div style="font-weight:bold; color:var(--primary); font-size: 1.2em;">${item.kohde}</div>
                            <div style="font-size:0.85em; margin: 5px 0;">${item.kuvaus || ''}</div>
                            <div style="font-weight: bold; color: var(--success); font-size: 0.9em;">${item.hinta === 0 ? 'Ilmainen' : item.hinta + ' â‚¬'}</div>
                        </div>
                        <div class="nappi-ryhma">
                            <a href="${item.linkki || '#'}" target="_blank" class="nappi" style="background:#6c757d; color:white; display:${item.linkki ? 'block' : 'none'}">ğŸ”— Sivu</a>
                            <a href="${mapsUrl}" target="_blank" class="nappi nappi-kartta">ğŸŒ Kartta</a>
                            <button class="nappi nappi-kayty ${onKayty ? 'aktiivinen' : ''}" onclick="toggleKayty('${item.kohde}')">
                                ${onKayty ? 'âœ“ KÃ¤yty' : 'Merkitse'}
                            </button>
                        </div>
                    </div>`;

                L.marker([item.lat, item.lon]).addTo(markerGroup).bindPopup(`
                    <div style="text-align:center; min-width:160px;">
                        <b style="color:var(--primary); font-size: 1.1em;">${item.kohde}</b><br>
                        <span style="font-size: 0.85em; color: #666;">${item.kategoria}</span><br>
                        <a href="${mapsUrl}" target="_blank" 
                           style="display:inline-block; margin-top:10px; padding:6px 12px; background:var(--primary); color:white; text-decoration:none; border-radius:4px; font-size:11px; font-weight:bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                           ğŸŒ Reittiohjeet (Maps)
                        </a>
                    </div>
                `);
            });
            document.getElementById('laskuri').textContent = `LÃ¶ytyi: ${kohteet.length}`;
        }

        function suodata() {
            const haku = document.getElementById('hakukentta').value.toLowerCase();
            const kat = document.getElementById('kategoriaSuodatin').value;
            const suodatetut = kaikkiKohteet.filter(i => 
                (i.kohde.toLowerCase().includes(haku) || (i.kategoria && i.kategoria.toLowerCase().includes(haku))) && (kat === 'kaikki' || i.kategoria === kat)
            );
            naytaKohteet(suodatetut);
        }

        function toggleKayty(id) {
            const config = cityConfig[nykyinenKaupunki];
            let list = JSON.parse(localStorage.getItem(config.storageKey)) || [];
            const idx = list.indexOf(id);
            if (idx > -1) list.splice(idx, 1); else list.push(id);
            localStorage.setItem(config.storageKey, JSON.stringify(list));
            suodata();
        }

        vaihdaKaupunki();
    </script>
</body>
</html>
