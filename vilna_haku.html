<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vilna - Matkaopas & GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --primary: #007bff;
            --success: #28a745;
            --warning: #f39c12;
            --bg: #f8f9fa;
            --dark: #2c3e50;
        }

        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 20px auto; padding: 0 20px; background-color: var(--bg); }
        h2 { border-bottom: 3px solid var(--primary); padding-bottom: 10px; color: var(--dark); }

        /* S√§√§ */
        .saa-sailyty {
            background: linear-gradient(135deg, #007bff, #00c6ff);
            color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px;
        }

        /* Kartta-alue */
        .kartta-sailyty { position: relative; margin-bottom: 25px; }
        #map { height: 450px; width: 100%; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1; }

        /* Sijaintinappi kartan p√§√§ll√§ */
        .gps-nappi {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px;
            padding: 8px 12px; cursor: pointer; font-weight: bold; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .gps-nappi:hover { background: #f4f4f4; }

        /* Haku */
        .haku-alue { 
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; 
            display: flex; gap: 10px; flex-wrap: wrap; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex-grow: 1; }

        /* Kortit */
        .kohde-kortti { 
            background: white; border-radius: 12px; padding: 20px; display: flex; gap: 20px; 
            margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .kayty { background-color: #e8f5e9 !important; border: 1px solid #a5d6a7; }
        .kohde-kuva { width: 110px; height: 110px; object-fit: cover; border-radius: 8px; flex-shrink: 0; background: #eee; }
        .kuvaus { font-size: 0.85em; color: #444; font-style: italic; margin: 8px 0; border-left: 3px solid var(--primary); padding-left: 10px; }

        .nappi-ryhma { display: flex; flex-direction: column; gap: 8px; min-width: 130px; }
        .nappi { cursor: pointer; padding: 10px; border: none; border-radius: 6px; font-size: 0.85em; text-align: center; text-decoration: none; font-weight: bold; }
        .nappi-sivu { background: #6c757d; color: white; }
        .nappi-kartta { background: var(--primary); color: white; }
        .nappi-kayty.aktiivinen { background: var(--success); color: white; }

        @media (max-width: 650px) {
            .kohde-kortti { flex-direction: column; }
            .kohde-kuva { width: 100%; height: 180px; }
            .nappi-ryhma { width: 100%; flex-direction: row; }
        }
    </style>
</head>
<body>

    <h2>üá±üáπ Vilna - Matkaopas & GPS</h2>

    <div id="saa-osio" class="saa-sailyty">
        <div id="nyky-temp" style="font-size: 1.5em; font-weight: bold;">Ladataan s√§√§t√§...</div>
        <div id="ennuste-rivit" style="display: flex; gap: 15px; margin-top: 5px; font-size: 0.9em;"></div>
    </div>

    <div class="kartta-sailyty">
        <div id="map"></div>
        <button class="gps-nappi" onclick="haeOmaSijainti()">üìç Miss√§ olen?</button>
    </div>

    <div class="haku-alue">
        <input type="text" id="hakukentta" placeholder="Etsi kohdetta..." oninput="suodata()">
        <select id="kategoriaSuodatin" onchange="suodata()">
            <option value="kaikki">Kaikki tyypit</option>
            <option value="Suosittu n√§ht√§vyys">Suosituimmat</option>
            <option value="N√§ht√§vyys">N√§ht√§vyydet</option>
            <option value="Museo">Museot</option>
            <option value="Ravintola">Ravintolat</option>
            <option value="Suosittu kahvila">Kahvilat</option>
        </select>
        <span id="laskuri"></span>
    </div>

    <div id="lista"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let kaikkiKohteet = [];
        let kaytyLista = JSON.parse(localStorage.getItem('kaytyVilna')) || [];
        let map, markerGroup, userMarker;

        // --- KARTAN ALUSTUS ---
        function alustaKartta() {
            map = L.map('map').setView([54.6872, 25.2797], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            markerGroup = L.layerGroup().addTo(map);
        }

        // --- OMA SIJAINTI (GPS) ---
        function haeOmaSijainti() {
            if (!navigator.geolocation) {
                alert("Selaimesi ei tue GPS-paikannusta.");
                return;
            }

            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                // Jos vanha merkki on, poistetaan se
                if (userMarker) map.removeLayer(userMarker);

                // Luodaan sininen pallo omalle sijainnille
                userMarker = L.circleMarker([lat, lon], {
                    radius: 10,
                    fillColor: "#007bff",
                    color: "white",
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map).bindPopup("<b>Olet t√§ss√§</b>").openPopup();

                // Keskistet√§√§n kartta omaan sijaintiin
                map.setView([lat, lon], 15);
            }, () => {
                alert("Sijaintia ei voitu hakea. Varmista, ett√§ olet sallinut paikannuksen.");
            });
        }

        function paivitaKartta(kohteet) {
            markerGroup.clearLayers();
            kohteet.forEach(item => {
                const marker = L.marker([item.lat, item.lon]);
                marker.bindPopup(`<b>${item.kohde}</b><br><small>${item.kategoria}</small>`);
                markerGroup.addLayer(marker);
            });
        }

        // --- DATA JA S√Ñ√Ñ ---
        async function haeSaa() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=54.6872&longitude=25.2797&current_weather=true&daily=temperature_2m_max&timezone=Europe%2FBerlin');
                const data = await res.json();
                document.getElementById('nyky-temp').textContent = `Vilna: ${Math.round(data.current_weather.temperature)}¬∞C`;
            } catch (e) {}
        }

        fetch('vilna_locations.json')
            .then(res => res.json())
            .then(data => {
                kaikkiKohteet = data;
                alustaKartta();
                suodata();
                haeSaa();
            });

        function naytaKohteet(kohteet) {
            const lista = document.getElementById('lista');
            lista.innerHTML = '';
            kohteet.forEach(item => {
                const id = item.kohde;
                const onKayty = kaytyLista.includes(id);
                const mapsUrl = `https://www.google.com/maps?q=${item.lat},${item.lon}`;
                
                lista.innerHTML += `
                    <div class="kohde-kortti ${onKayty ? 'kayty' : ''}">
                        <img src="${item.kuva}" class="kohde-kuva" onerror="this.src='https://placehold.co/120x120?text=Ei+kuvaa'">
                        <div class="kohde-sisalto">
                            <div style="font-size: 0.7em; text-transform: uppercase; color: #999; font-weight: bold;">${item.kategoria}</div>
                            <div class="nimi">${item.kohde}</div>
                            <div class="kuvaus">${item.kuvaus || ''}</div>
                            <div style="font-weight: bold; color: var(--success);">${item.hinta === 0 ? 'Ilmainen' : item.hinta + ' ‚Ç¨'}</div>
                        </div>
                        <div class="nappi-ryhma">
                            <a href="${item.linkki}" target="_blank" class="nappi nappi-sivu">üîó Sivu</a>
                            <a href="${mapsUrl}" target="_blank" class="nappi nappi-kartta">üåê Kartta</a>
                            <button class="nappi nappi-kayty ${onKayty ? 'aktiivinen' : ''}" onclick="toggleKayty('${id}')">
                                ${onKayty ? '‚úì K√§yty' : 'Merkitse'}
                            </button>
                        </div>
                    </div>`;
            });
            document.getElementById('laskuri').textContent = `L√∂ytyi: ${kohteet.length}`;
            paivitaKartta(kohteet);
        }

        function suodata() {
            const haku = document.getElementById('hakukentta').value.toLowerCase();
            const kat = document.getElementById('kategoriaSuodatin').value;
            const suodatetut = kaikkiKohteet.filter(i => 
                (i.kohde.toLowerCase().includes(haku)) && (kat === 'kaikki' || i.kategoria === kat)
            );
            naytaKohteet(suodatetut);
        }

        function toggleKayty(id) {
            const index = kaytyLista.indexOf(id);
            if (index > -1) kaytyLista.splice(index, 1);
            else kaytyLista.push(id);
            localStorage.setItem('kaytyVilna', JSON.stringify(kaytyLista));
            suodata();
        }
    </script>
</body>
</html>
